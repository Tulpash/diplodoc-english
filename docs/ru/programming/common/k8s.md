# Kubernetes

K8s - платформа для оркестрации контейнеров, которая автоматизирует развертывание, масштабирование и управление контейнерезированными приложениями.

*Кластер* - основная единица, состоящая из набора улов (nodes). Кластер делится на **Control Plane** и **Worker Nodes** (узлы с подами).
- Control Plane: Управляет кластеров, принимает решения о  развертывании, масштабировании и т.д.
- Worker Nodes: Выполняют контейнерезирвоанные приложения

## Основные компоненты (Control Plane)
1. **kube-apiserver** - центральная точка управления, через которую все взаимодействуют с кластером. Принимает запросы от пользователей, компонентов и обновляет состояние кластера.
1. **etcd** - распределенная KV БД, хранит конфиги, статусы, метаданные.
1. **kube-scheduler** - отвесает за размещение подов на подходящих узлах на оснвое требований ресурсов, политик и ограничений.
1. **kube-controller-manager** - запускает контроллеры которые следят за состоянием кластера иприводят его к желаемому состоянию.

## Основные компоненты (Worker Nodes)
1. **kubelet** - агент работающий на каждом узле. Следит за работой контейнеров на узле, управляет ими через контейнерный рантайм (CRI-O, containerd, ...)
1. **kube-proxy** - управляет сетевыми правилами на узлах, обеспечивает маршрутизацию трафика к подам и сервисам.
1. **Container Runtime** - ПО для запуска контейнеров.

## Административные компоненты
- **kubectl** - утилита CLI для взаимодействия с *kube-apiserver*.

## Объекты
Объекты — это сущности, которые описывают состояние и поведение приложений в K8s. Они создаются через YAML/JSON-файлы и отправляются в API Server.

- Pod - минимальная единица развертывания, содержащия один или несколько контейнеров, которые используют одни и те же ресурсы (сеть, хранилище, ...).
- Deployment - управляет наборами подов, обеспечивает их масштабирование, обновление и откат. Используется для stateless-приложений.
- StatefulSet - управляет наборами подов, требующих постоянного состояния, например БД. Гарантирует уникальные имена и порядок создания подов.
- ReplicaSet - обеспечивает запуск указанного количества копий подов, обычно управляется *Deployment*.
- Service - абстракция для маршрутизации сетевого трафика к подам, отвечает за конфигурацию IP, LoadBalancer и т.д.
- ConfigMap - хранит KV конфиг для подов.
- Secret - хранит конфиденциальные данные в зашифрованном виде.
- PersistentVolume - абстракция хранилища кластера.
- PersistentVolumeClaim - запрос на использование хранилища подами.
- Namespace - логическое разделение ресурсов в кластере.
- Ingress - управляет внешним HTTP/HTTPS трафиком направляя его к сервисам.
- Job - запускает поды для выполнения одноразовых задач.
- CronJob - запуск *Job* по расписанию.
- DaemonSet - обеспечивает запуск пода на наружном узле.
- HorizontalPodAutoscaler - автоматичски масштабирует количество подов на основе метрик.
- NetworkPolicy - определяет правила сетевого доступа между подами.

## Как это рабоатет
- Пользователь создает конфиг, описывающий объект, и отправляет его через *kubectl* в *kube-apiserver*
- *kube-apiserver* сохраняет состояние в etcd
- *kube-scheduler* распределяет поды на узлы
- *kubelet* на узлах запускает контейнеры через рантайм
- *kube-controller-manager* следит за состоянием и корерктирует его
- *kube-proxy* (Ingress, Service) обеспечивает сетевую связность

## Пример и разбор конфига
```yaml
apiVersion: apps/v1 # версия синтаксиса
kind: Deployment # тип объекта который мы конфигурируем
metadata: # раздел отвечающий за метаданные объекта
  name: my-app # пространство имен в котором находится объект (логическое разделение)
  namespace: default # имя объекта, уникальное в рамках namespace
spec: # описание желаемого состояния объекта
  replicas: 3 # указывает кол-во подов которое должно быть запущено (создает ReplicaSet)
  selector: # раздел отвечающий за то какие поды находятся под управлением Deployment
    matchLabels: # указывает что нужно отслеживать поды с меткой 'app: my-app'
      app: my-app
  template: # шаблон создания подов которыми управляет Deployment
    metadata: # указываем метаданные подов
      labels: # добавляет метку 'app: my-app' в метаданные каждого создаваемого пода (совпадает с selector)
        app: my-app
    spec: # спецификация пода, описывает контейнеры и их настройки
      containers: # список контейнеров в поде
        - name: my-app-container # имя контейнера
        - image: nginx:latest # образ контейнера
        - ports:
            - containerPort: 80 # порт контейнера
```
Данный конфиг создаст **Deployment**, он в свою очередь создаст **ReplicaSet**, в котором будет лежать 3 **Pod**.