# CAP теорема (Теорема Брюера)
CAP-теорема, предложенная Эриком Брюером в 2000 году и формально доказанная в 2002 году Гилбертом и Линчем, гласит, что, в распределённой системе, обрабатывающей данные, невозможно одновременно гарантировать:
- Consistency (Консистентность): Каждый запрос к системе возвращает согласованное (одинаковое) состояние данных на всех узлах.
- Availability (Доступность): Каждый запрос (кроме тех, что завершаются ошибкой) получает ответ, даже если некоторые узлы недоступны.
- Partition Tolerance (Устойчивость к разделению): Система продолжает работать, даже если некоторые узлы теряют связь друг с другом (сетевые сбои, разделение сети).

## Подробное объяснение свойств
**Consistency (Консистентность)**
*Определение:* Все узлы системы видят одно и то же состояние данных в любой момент времени. Если данные обновляются на одном узле, все последующие запросы на чтение (с любого узла) возвращают обновлённое значение.
*Пример:* В банковской системе, если клиент перевёл деньги, все узлы (серверы) должны сразу показать обновлённый баланс.
*Как достигается:* Через синхронную репликацию, где данные записываются на все узлы перед подтверждением операции.

**Availability (Доступность)**
*Определение:* Система отвечает на каждый запрос (даже при сбоях отдельных узлов), возвращая либо результат, либо ошибку, но не "зависает".
*Пример:* В интернет-магазине (например, Ozon) пользователь может сделать заказ, даже если некоторые серверы недоступны.
*Как достигается:* Через асинхронную репликацию или кэширование, позволяя узлам отвечать независимо.

**Partition Tolerance (Устойчивость к разделению)**
*Определение:* Система продолжает работать, даже если некоторые узлы теряют связь (например, из-за сетевых сбоев). Разделение сети (network partition) — это ситуация, когда узлы не могут обмениваться данными.
*Пример:* Если сеть между дата-центрами разрывается, система всё равно должна обрабатывать запросы на доступных узлах.
*Как достигается:* Через механизмы репликации, кэширования или локальной обработки данных.

{% note warning %}

В реальных распределённых системах сетевое разделение неизбежно (сети ненадёжны), поэтому Partition Tolerance — это обязательное свойство. Таким образом, выбор стоит между CP и AP.

{% endnote %}

## Ключевой вывод
В случае сетевого разделения (partition), система должна выбрать между консистентностью и доступностью. Это означает, что вы можете построить систему, которая либо:
- CP (Consistent and Partition Tolerant): Жертвует доступностью ради консистентности.
- AP (Available and Partition Tolerant): Жертвует консистентностью ради доступности.
- CA: На практике CA-системы редки, так как сетевое разделение неизбежно в распределённых системах, и полная устойчивость к разделению обязательна.

## Компромиссы
**CP (Консистентность + Устойчивость к разделению):**
Система отказывается отвечать на запросы, пока данные не синхронизированы между узлами.
*Пример:* Банковская система, где нельзя допустить несогласованность баланса.
*Проблема:* Жертвуется доступность — запросы могут быть отклонены, если узлы не синхронизированы.

**AP (Доступность + Устойчивость к разделению):**
Система продолжает отвечать, даже если данные на узлах несогласованы (eventual consistency).
*Пример:* Социальная сеть, где лайки могут временно отображаться с задержкой.
*Проблема:* Возможна временная несогласованность данных (stale data).

**CA (Консистентность + Доступность):**
Возможна только в системах без сетевого разделения (например, одиночный сервер).
В распределённых системах CA нереалистична, так как сетевое разделение неизбежно.