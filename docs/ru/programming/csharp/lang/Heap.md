# Куча
В .NET куча делится на 4 составляющих: SOH, LOH, POH, FOH. Каждая из них выполняет свои функции и GC работает с каждой по разному.

## Small object heap (SOH)
Хранит объекты размером < *85 КБ*.

**Оосбенности:**
- Делится на три поколения: **Gen 0**, **Gen 1**, **Gen 2**
- Поддерживает компактирование (уплотнение объектов для устранения фрагментации)
- Сборка мусора происхдит чаще в более младштх поколениях

**Устройство:**
- Объекты находятся в непрерывной области памяти
- Логически является частью всех трех поколений
- GC использует указатели для отслеживания объектов и их поколений в generation_table

## Large object heap (LOH)
Хранит объекты размером ≥ *85 КБ*.

**Особенности:**
- Не делится на поколения
- Сборко проходит редко
- До *.NET 4.5.1* не компактирвоалась, в современных версиях есть возможность включить компактирование (*GCSettings.LargeObjectHeapCompactionMode*)

**Устройство:**
- Объекты хранятся в отдельных блоках памяти
- Логически является частью **Gen 2**

**Как проимходит компактирвоание?**
Объекты могут компактироваться как в рамках одного блока памяти так и копироваться между разными блоками для снижения фрагментации.

## Pinned object heap (POH)
Появилась в **.NET 5**, хранит закрепленные (fixed) в памяти объекты. Введена для уменьшения фрагментации в *SOH* и *LOH*.

**Особенности:**
- Объекты не компактируются, так как они закрплены
- Сборка мусора происходит редко

**Устройство:**
- Объекты хранятся в отдельной области памяти
- Логически является частью **Gen 2**

## Frozen object heap (FOH)
Храни твечные объекты, которые не надо убирать.

**Особенности:**
- Объекты не скаируются GC, в этом нет смысла
- Не имеет публичного API

**Устройство:**
- Хранятся в непрерывнйо статичной области памяти

## Как происходит сборка мусора?
В *.NET* используется плгоритм **mark-and-sweep**. Суть проста: алгоритм проходит по графу объектов и помечает достижимые объекты (недостижимые пометить невозможно), после для не помеченных объектов память очищается, а объекты пережившие уборку попадают в слежующее поеоление, если уборка была в **Gen 2**, то объкты остаются там же.После этого происхолдит компактирование длы SOH, и LOH если оно настроено.